@page "/tasks/{userid:int}"

@using Microsoft.AspNetCore.Components
@using System.Text.Json
@using WorkTimeApp.Shared.Model
@using WorkTimeApp.Shared.Services

@inject NavigationManager Navigation
@inject ApiService ApiService

<PageTitle>Aktywne Zadania</PageTitle>

<div class="container mt-4">
    <h2 class="text-primary mb-3">
        <i class="bi bi-list-task"></i> Aktywne Zadania
    </h2>

    <div class="mb-4">
        <button class="btn btn-success" @onclick="AddTask">
            <i class="bi bi-plus-circle"></i> Dodaj Zadanie
        </button>
    </div>

    <p class="text-muted">Aktualnie aktywne zadania: <strong>@tasks.Count(t => !t.completed)</strong></p>

    @if (tasks.Any())
    {
        <div class="task-cards">
            <WorkTimeApp.Shared.Components.TaskList tasks="@tasks" Userid="@Userid" FilterFunc="ActiveFilter"></WorkTimeApp.Shared.Components.TaskList>
        </div>
    }
    else
    {
        <div class="alert alert-info text-center">
            <i class="bi bi-info-circle"></i> Brak aktywnych zadań.
        </div>
    }
</div>

<link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css" rel="stylesheet">

<style>
    .task-cards {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
        gap: 1rem;
    }

    .btn i {
        margin-right: 6px;
    }

    h2 i {
        margin-right: 8px;
    }

    .alert {
        font-size: 1.1rem;
        padding: 1rem;
        border-radius: 8px;
    }
</style>

@code {
    [Parameter]
    public int Userid { get; set; }

    private bool ActiveFilter(TaskModel task) => !task.completed;

    public List<TaskModel> tasks = new();

    private void AddTask() => Navigation.NavigateTo($"addTask/{Userid}");

    protected override async Task OnInitializedAsync()
    {
        var result = await ApiService.GetProtectedDataAsync("/api/tasks/user/");
        if (!string.IsNullOrEmpty(result))
        {
            var deserializedTask = JsonSerializer.Deserialize<List<TaskModel>>(result);
            if (deserializedTask != null)
                tasks = deserializedTask;
        }
    }
}
